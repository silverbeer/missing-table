name: Deploy to Dev (GKE)

on:
  push:
    branches:
      - feature/**
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'helm/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch:

env:
  PROJECT_ID: missing-table
  REGION: us-central1
  GAR_LOCATION: us-central1
  CLUSTER_NAME: missing-table-dev
  NAMESPACE: missing-table-dev

jobs:
  build-and-deploy:
    name: Build and Deploy to Dev
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Configure Docker to use gcloud as credential helper
      run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

    - name: Build and push backend image
      id: build-backend
      run: |
        IMAGE_TAG=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/missing-table/backend:${{ github.sha }}
        IMAGE_LATEST=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/missing-table/backend:latest

        docker build -f backend/Dockerfile -t $IMAGE_TAG -t $IMAGE_LATEST backend/
        docker push $IMAGE_TAG
        docker push $IMAGE_LATEST

        echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Build and push frontend image
      id: build-frontend
      run: |
        IMAGE_TAG=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/missing-table/frontend:${{ github.sha }}
        IMAGE_LATEST=${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/missing-table/frontend:latest

        docker build -f frontend/Dockerfile \
          --build-arg VUE_APP_API_URL=https://dev.missingtable.com \
          --build-arg VUE_APP_SUPABASE_URL=${{ secrets.SUPABASE_URL }} \
          --build-arg VUE_APP_SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} \
          --build-arg VUE_APP_DISABLE_SECURITY=true \
          -t $IMAGE_TAG -t $IMAGE_LATEST frontend/
        docker push $IMAGE_TAG
        docker push $IMAGE_LATEST

        echo "image=$IMAGE_TAG" >> $GITHUB_OUTPUT

    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
          --region ${{ env.REGION }} \
          --project ${{ env.PROJECT_ID }}

    - name: Install Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Create values-dev.yaml from GitHub Secrets
      run: |
        echo "Creating values-dev.yaml from GitHub secrets..."

        cat > helm/missing-table/values-dev.yaml <<EOF
        # Dev environment configuration for GKE (Auto-generated from GitHub Secrets)
        namespace: missing-table-dev

        secrets:
          supabaseUrl: "${{ secrets.SUPABASE_URL }}"
          supabaseAnonKey: "${{ secrets.SUPABASE_ANON_KEY }}"
          supabaseServiceKey: "${{ secrets.SUPABASE_SERVICE_KEY }}"
          supabaseJwtSecret: "${{ secrets.SUPABASE_JWT_SECRET }}"
          serviceAccountSecret: "${{ secrets.SERVICE_ACCOUNT_SECRET }}"

        backend:
          replicaCount: 1
          image:
            repository: us-central1-docker.pkg.dev/missing-table/missing-table/backend
            tag: ${{ github.sha }}
            pullPolicy: Always
          env:
            environment: "development"
            logLevel: "info"
            disableLogfire: "true"
            disableSecurity: "true"
            extra:
              CORS_ORIGINS: "http://34.133.125.204:8080,https://dev.missingtable.com"
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          service:
            loadBalancer:
              enabled: true
              port: 8000

        frontend:
          replicaCount: 1
          image:
            repository: us-central1-docker.pkg.dev/missing-table/missing-table/frontend
            tag: ${{ github.sha }}
            pullPolicy: Always
          env:
            nodeEnv: "production"
            apiUrl: "http://34.135.217.253:8000"
            vueAppDisableSecurity: "true"
            extra: {}
          command: []
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            initialDelaySeconds: 5
            periodSeconds: 5
          service:
            type: LoadBalancer

        redis:
          enabled: false
        EOF

    - name: Deploy to GKE with Helm
      run: |
        # Deploy using Helm
        helm upgrade missing-table ./helm/missing-table \
          --install \
          --namespace ${{ env.NAMESPACE }} \
          --create-namespace \
          --values ./helm/missing-table/values-dev.yaml \
          --wait \
          --timeout 5m

    - name: Verify deployment
      run: |
        kubectl rollout status deployment/missing-table-backend -n ${{ env.NAMESPACE }} --timeout=300s
        kubectl rollout status deployment/missing-table-frontend -n ${{ env.NAMESPACE }} --timeout=300s

    - name: Get service URLs
      run: |
        echo "### Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Backend Image**: ${{ steps.build-backend.outputs.image }}" >> $GITHUB_STEP_SUMMARY
        echo "**Frontend Image**: ${{ steps.build-frontend.outputs.image }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        BACKEND_IP=$(kubectl get svc missing-table-backend -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "pending")
        FRONTEND_IP=$(kubectl get svc missing-table-frontend -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' || echo "pending")

        echo "**Backend URL**: http://$BACKEND_IP:8000" >> $GITHUB_STEP_SUMMARY
        echo "**Frontend URL**: http://$FRONTEND_IP:8080" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Namespace**: ${{ env.NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

    - name: Run health checks
      run: |
        # Wait for LoadBalancer IP
        sleep 30

        BACKEND_IP=$(kubectl get svc missing-table-backend -n ${{ env.NAMESPACE }} -o jsonpath='{.status.loadBalancer.ingress[0].ip}')

        if [ -n "$BACKEND_IP" ]; then
          echo "Testing backend health endpoint..."
          curl -f "http://$BACKEND_IP:8000/health" || echo "Health check failed (may still be starting)"
        else
          echo "Backend LoadBalancer IP not yet assigned"
        fi
