name: Publish Quality Reports

on:
  push:
    branches: ['**']
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  S3_BUCKET: 'quality-missingtable-com'
  CLOUDFRONT_DISTRIBUTION_ID: 'E15AUGI7OKJ99L'

permissions:
  id-token: write   # Required for OIDC
  contents: read

jobs:
  publish-coverage:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-quality
          aws-region: us-east-1

      - name: Install Allure CLI
        run: |
          curl -fsSL https://github.com/allure-framework/allure2/releases/download/2.30.0/allure-2.30.0.tgz | tar -xz
          echo "$PWD/allure-2.30.0/bin" >> $GITHUB_PATH

      - name: Extract build info
        id: build-info
        run: |
          # Read version from VERSION file (matches production app format)
          APP_VERSION=$(cat VERSION 2>/dev/null || echo "0.0.0")
          # Use GitHub run number as build suffix (same as production CI/CD)
          VERSION="${APP_VERSION}.${{ github.run_number }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION"
          echo "Branch: ${{ github.ref_name }}"

      - name: Verify Allure CLI
        run: |
          allure --version

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run backend unit tests with coverage and Allure
        id: backend-tests
        run: |
          cd backend
          mkdir -p allure-results
          uv run pytest tests/ -m unit \
            --cov=. \
            --cov-report=html \
            --cov-report=json \
            --cov-fail-under=0 \
            --alluredir=allure-results \
            -v
        continue-on-error: true

      - name: Generate backend Allure report
        run: |
          cd backend
          allure generate allure-results -o allure-report --clean

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Run frontend unit tests with coverage
        id: frontend-tests
        run: |
          cd frontend
          npm ci
          npm run test:coverage
        continue-on-error: true

      - name: Generate API coverage page
        run: |
          cd backend
          mkdir -p api-coverage-report
          uv run ../scripts/generate-api-coverage.py \
            --inventory api_inventory.json \
            --output api-coverage-report/index.html \
            --commit-sha ${{ github.sha }} \
            --run-id ${{ github.run_id }}

      - name: Add dashboard navigation to reports
        env:
          BUILD_VERSION: ${{ steps.build-info.outputs.version }}
          BUILD_BRANCH: ${{ steps.build-info.outputs.branch }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          # Banner HTML with build info
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          BANNER="<div style=\"background:#2563eb;color:white;padding:8px 16px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;justify-content:space-between;\"><a href=\"https://quality.missingtable.com\" style=\"color:white;text-decoration:none;display:flex;align-items:center;gap:8px;\"><span style=\"font-size:18px;\">←</span> Back to Quality Dashboard</a><span style=\"opacity:0.9;\">Build ${BUILD_VERSION} · ${BUILD_BRANCH} · ${COMMIT_SHORT}</span></div><div style=\"height:40px;\"></div>"

          # Inject into backend Allure report
          sed -i "s|<body>|<body>${BANNER}|" backend/allure-report/index.html

          # Inject into backend coverage report (coverage.py uses <body class="indexfile">)
          sed -i 's|<body class="indexfile">|<body class="indexfile">'"${BANNER}"'|' backend/htmlcov/index.html

          # Inject into frontend coverage report (c8/v8 uses <body>)
          sed -i "s|<body>|<body>${BANNER}|" frontend/coverage/index.html

          # Inject into frontend Vitest HTML report
          sed -i "s|<body>|<body>${BANNER}|" frontend/html-report/index.html

          # Inject into API coverage page
          sed -i "s|<body>|<body>${BANNER}|" backend/api-coverage-report/index.html

      - name: Extract run metadata
        run: |
          cd backend
          uv run ../scripts/extract-run-metadata.py \
            --run-id ${{ github.run_id }} \
            --commit-sha ${{ github.sha }} \
            --trigger ${{ github.event_name }} \
            --workflow unit \
            --version "${{ steps.build-info.outputs.version }}" \
            --branch "${{ steps.build-info.outputs.branch }}" \
            --backend-allure-dir allure-report \
            --backend-coverage-json coverage.json \
            --frontend-results-json ../frontend/test-results.json \
            --frontend-coverage-json ../frontend/coverage/coverage-final.json \
            --output /tmp/run-metadata.json

      - name: Download history and compare runs
        run: |
          # Download existing history
          aws s3 cp s3://${S3_BUCKET}/data/history.json /tmp/history.json || echo '{"runs":[]}' > /tmp/history.json

          # Download previous run metadata for detailed comparison (if exists)
          if [ -f /tmp/history.json ]; then
            PREV_RUN_ID=$(python3 -c "import json; h=json.load(open('/tmp/history.json')); print(h['runs'][0]['run_id'] if h.get('runs') else '')" 2>/dev/null || echo "")
            if [ -n "$PREV_RUN_ID" ]; then
              PREV_DATE=$(python3 -c "import json; from datetime import datetime; h=json.load(open('/tmp/history.json')); ts=h['runs'][0].get('timestamp',''); print(datetime.fromisoformat(ts.replace('Z','+00:00')).strftime('%Y-%m-%d') if ts else '')" 2>/dev/null || echo "")
              if [ -n "$PREV_DATE" ]; then
                aws s3 cp s3://${S3_BUCKET}/runs/missing-table/prod/${PREV_DATE}/${PREV_RUN_ID}/metadata.json /tmp/prev-metadata.json || true
              fi
            fi
          fi

          # Compare runs
          cd backend
          if [ -f /tmp/prev-metadata.json ]; then
            uv run ../scripts/compare-runs.py \
              --current /tmp/run-metadata.json \
              --history /tmp/history.json \
              --previous-metadata /tmp/prev-metadata.json \
              --output /tmp/comparison.json
          else
            uv run ../scripts/compare-runs.py \
              --current /tmp/run-metadata.json \
              --history /tmp/history.json \
              --output /tmp/comparison.json
          fi

          # Update history index
          uv run ../scripts/update-history-index.py \
            --current-run /tmp/run-metadata.json \
            --history /tmp/history.json \
            --output /tmp/history.json \
            --max-runs 10

      - name: Generate dashboard landing page
        run: |
          cd backend
          uv run ../scripts/generate-quality-dashboard.py \
            --output /tmp/index.html \
            --commit-sha ${{ github.sha }} \
            --run-id ${{ github.run_id }} \
            --backend-allure-dir allure-report \
            --backend-coverage-json coverage.json \
            --frontend-results-json ../frontend/test-results.json \
            --frontend-coverage-json ../frontend/coverage/coverage-final.json \
            --include-journey \
            --include-contract \
            --api-inventory-json api_inventory.json \
            --history-json /tmp/history.json \
            --comparison-json /tmp/comparison.json

      - name: Upload to S3
        run: |
          # Upload latest reports
          aws s3 sync backend/allure-report/ s3://${S3_BUCKET}/latest/missing-table/prod/allure/ \
            --delete \
            --cache-control "max-age=300"

          aws s3 sync backend/htmlcov/ s3://${S3_BUCKET}/latest/missing-table/prod/backend-unit/ \
            --delete \
            --cache-control "max-age=300"

          aws s3 sync frontend/coverage/ s3://${S3_BUCKET}/latest/missing-table/prod/frontend-unit/ \
            --delete \
            --cache-control "max-age=300"

          # Upload Vitest HTML report (excluding .gz files first)
          aws s3 sync backend/api-coverage-report/ s3://${S3_BUCKET}/latest/missing-table/prod/api-coverage/ \
            --delete \
            --cache-control "max-age=300"

          aws s3 sync frontend/html-report/ s3://${S3_BUCKET}/latest/missing-table/prod/frontend-vitest/ \
            --delete \
            --exclude "*.gz" \
            --cache-control "max-age=300"

          # Upload .gz files with proper Content-Encoding header
          aws s3 cp frontend/html-report/html.meta.json.gz \
            s3://${S3_BUCKET}/latest/missing-table/prod/frontend-vitest/html.meta.json.gz \
            --content-encoding gzip \
            --content-type "application/json" \
            --cache-control "max-age=300"

          aws s3 cp /tmp/index.html s3://${S3_BUCKET}/index.html \
            --cache-control "max-age=300" \
            --content-type "text/html"

          # Upload raw JSON files for cross-workflow dashboard generation
          aws s3 cp backend/coverage.json s3://${S3_BUCKET}/latest/missing-table/prod/data/backend-coverage.json \
            --cache-control "max-age=300"
          aws s3 cp frontend/test-results.json s3://${S3_BUCKET}/latest/missing-table/prod/data/frontend-results.json \
            --cache-control "max-age=300"
          aws s3 cp frontend/coverage/coverage-final.json s3://${S3_BUCKET}/latest/missing-table/prod/data/frontend-coverage.json \
            --cache-control "max-age=300"
          aws s3 cp backend/api_inventory.json s3://${S3_BUCKET}/latest/missing-table/prod/data/api-inventory.json \
            --cache-control "max-age=300"

          # Upload history index
          aws s3 cp /tmp/history.json s3://${S3_BUCKET}/data/history.json \
            --cache-control "max-age=300"

          # Archive run reports
          RUN_DATE=$(date -u +"%Y-%m-%d")
          aws s3 sync backend/allure-report/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/allure/ \
            --cache-control "max-age=31536000"
          aws s3 sync backend/api-coverage-report/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/api-coverage/ \
            --cache-control "max-age=31536000"
          aws s3 sync backend/htmlcov/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/backend-unit/ \
            --cache-control "max-age=31536000"
          aws s3 sync frontend/coverage/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/frontend-unit/ \
            --cache-control "max-age=31536000"
          aws s3 sync frontend/html-report/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/frontend-vitest/ \
            --exclude "*.gz" \
            --cache-control "max-age=31536000"
          aws s3 cp frontend/html-report/html.meta.json.gz \
            s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/frontend-vitest/html.meta.json.gz \
            --content-encoding gzip \
            --content-type "application/json" \
            --cache-control "max-age=31536000"

          # Archive run metadata for future comparisons
          aws s3 cp /tmp/run-metadata.json \
            s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/metadata.json \
            --cache-control "max-age=31536000"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/*"

      - name: Summary
        run: |
          # Backend metrics
          BE_PASSED=$(python3 -c "import json; print(json.load(open('backend/allure-report/widgets/summary.json'))['statistic']['passed'])")
          BE_TOTAL=$(python3 -c "import json; print(json.load(open('backend/allure-report/widgets/summary.json'))['statistic']['total'])")
          BE_COV=$(python3 -c "import json; print(f\"{json.load(open('backend/coverage.json'))['totals']['percent_covered']:.1f}\")" 2>/dev/null || echo "N/A")

          # Frontend metrics
          FE_PASSED=$(python3 -c "import json; print(json.load(open('frontend/test-results.json'))['numPassedTests'])")
          FE_TOTAL=$(python3 -c "import json; print(json.load(open('frontend/test-results.json'))['numTotalTests'])")
          FE_COV=$(python3 -c "import json; d=json.load(open('frontend/coverage/coverage-final.json')); t=sum(len(v['s']) for v in d.values()); c=sum(sum(1 for x in v['s'].values() if x>0) for v in d.values()); print(f'{c/t*100:.1f}' if t>0 else 'N/A')" 2>/dev/null || echo "N/A")

          echo "### Quality Reports Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** https://quality.missingtable.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reports:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend Tests (pytest + Allure)](https://quality.missingtable.com/latest/missing-table/prod/allure/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Backend Coverage](https://quality.missingtable.com/latest/missing-table/prod/backend-unit/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Frontend Tests (Vitest)](https://quality.missingtable.com/latest/missing-table/prod/frontend-vitest/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Frontend Coverage](https://quality.missingtable.com/latest/missing-table/prod/frontend-unit/)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Coverage](https://quality.missingtable.com/latest/missing-table/prod/api-coverage/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Tests | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${BE_PASSED}/${BE_TOTAL} | ${BE_COV}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${FE_PASSED}/${FE_TOTAL} | ${FE_COV}% |" >> $GITHUB_STEP_SUMMARY
