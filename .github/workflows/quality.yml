name: Publish Quality Reports

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'unit'
        type: choice
        options:
          - 'unit'
          - 'all'

env:
  PYTHON_VERSION: '3.13'
  S3_BUCKET: 'quality-missingtable-com'
  CLOUDFRONT_DISTRIBUTION_ID: 'E15AUGI7OKJ99L'

jobs:
  publish-quality:
    name: Run Tests & Publish
    runs-on: [self-hosted, quality-runner]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Allure CLI
        run: |
          allure --version

      - name: Setup Python with uv
        run: |
          cd backend
          uv python install 3.13
          uv sync --python 3.13

      - name: Run unit tests with coverage and Allure
        id: unit-tests
        run: |
          cd backend
          mkdir -p allure-results
          uv run pytest tests/ -m unit \
            --cov=. \
            --cov-report=html \
            --cov-report=json \
            --cov-fail-under=0 \
            --alluredir=allure-results \
            -v
        continue-on-error: true

      - name: Generate Allure report
        run: |
          cd backend
          allure generate allure-results -o allure-report --clean

      - name: Add dashboard navigation to reports
        run: |
          cd backend

          # Banner HTML to inject
          BANNER='<div style="background:#2563eb;color:white;padding:8px 16px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;gap:8px;"><a href="https://quality.missingtable.com" style="color:white;text-decoration:none;display:flex;align-items:center;gap:8px;"><span style="font-size:18px;">←</span> Back to Quality Dashboard</a></div><div style="height:40px;"></div>'

          # Inject into Allure report
          sed -i "s|<body>|<body>${BANNER}|" allure-report/index.html

          # Inject into Coverage report
          sed -i "s|<body>|<body>${BANNER}|" htmlcov/index.html

      - name: Extract coverage percentage
        id: coverage
        run: |
          cd backend
          if [ -f coverage.json ]; then
            COVERAGE=$(python3 -c "import json; print(f\"{json.load(open('coverage.json'))['totals']['percent_covered']:.1f}\")")
          else
            COVERAGE="N/A"
          fi
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Count test results
        id: test-counts
        run: |
          cd backend
          PASSED=$(find allure-results -name "*.json" -exec grep -l '"status":"passed"' {} \; 2>/dev/null | wc -l | tr -d ' ')
          FAILED=$(find allure-results -name "*.json" -exec grep -l '"status":"failed"' {} \; 2>/dev/null | wc -l | tr -d ' ')
          TOTAL=$((PASSED + FAILED))
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Create dashboard landing page
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          RUN_ID=${{ github.run_id }}
          COMMIT_SHA=${{ github.sha }}
          COMMIT_SHORT=${COMMIT_SHA:0:7}
          TEST_STATUS=${{ steps.unit-tests.outcome }}
          COVERAGE=${{ steps.coverage.outputs.percentage }}
          TESTS_PASSED=${{ steps.test-counts.outputs.passed }}
          TESTS_FAILED=${{ steps.test-counts.outputs.failed }}
          TESTS_TOTAL=${{ steps.test-counts.outputs.total }}

          if [ "$TEST_STATUS" = "success" ]; then
            STATUS_COLOR="#22863a"
            STATUS_ICON="✅"
            STATUS_BG="#dcffe4"
          else
            STATUS_COLOR="#cb2431"
            STATUS_ICON="❌"
            STATUS_BG="#ffeef0"
          fi

          cp .github/templates/dashboard.html /tmp/index.html
          sed -i "s|TIMESTAMP|${TIMESTAMP}|g" /tmp/index.html
          sed -i "s|RUNID|${RUN_ID}|g" /tmp/index.html
          sed -i "s|COMMITSHA|${COMMIT_SHA}|g" /tmp/index.html
          sed -i "s|COMMITSHORT|${COMMIT_SHORT}|g" /tmp/index.html
          sed -i "s|TESTSTATUS|${TEST_STATUS}|g" /tmp/index.html
          sed -i "s|STATUSCOLOR|${STATUS_COLOR}|g" /tmp/index.html
          sed -i "s|STATUSICON|${STATUS_ICON}|g" /tmp/index.html
          sed -i "s|STATUSBG|${STATUS_BG}|g" /tmp/index.html
          sed -i "s|COVERAGE|${COVERAGE}|g" /tmp/index.html
          sed -i "s|TESTSPASSED|${TESTS_PASSED}|g" /tmp/index.html
          sed -i "s|TESTSFAILED|${TESTS_FAILED}|g" /tmp/index.html
          sed -i "s|TESTSTOTAL|${TESTS_TOTAL}|g" /tmp/index.html

      - name: Upload to S3
        run: |
          aws s3 sync backend/allure-report/ s3://${S3_BUCKET}/latest/missing-table/prod/allure/ \
            --delete \
            --cache-control "max-age=300"

          aws s3 sync backend/htmlcov/ s3://${S3_BUCKET}/latest/missing-table/prod/backend-unit/ \
            --delete \
            --cache-control "max-age=300"

          aws s3 cp /tmp/index.html s3://${S3_BUCKET}/index.html \
            --cache-control "max-age=300" \
            --content-type "text/html"

          RUN_DATE=$(date -u +"%Y-%m-%d")
          aws s3 sync backend/allure-report/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/allure/ \
            --cache-control "max-age=31536000"
          aws s3 sync backend/htmlcov/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/backend-unit/ \
            --cache-control "max-age=31536000"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/*"

      - name: Summary
        run: |
          echo "### Quality Reports Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dashboard:** https://quality.missingtable.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reports:**" >> $GITHUB_STEP_SUMMARY
          echo "- [Allure Report](https://quality.missingtable.com/latest/missing-table/prod/allure/)" >> $GITHUB_STEP_SUMMARY
          echo "- [Coverage Report](https://quality.missingtable.com/latest/missing-table/prod/backend-unit/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage:** ${{ steps.coverage.outputs.percentage }}%" >> $GITHUB_STEP_SUMMARY
          echo "**Tests:** ${{ steps.test-counts.outputs.passed }} passed / ${{ steps.test-counts.outputs.total }} total" >> $GITHUB_STEP_SUMMARY
