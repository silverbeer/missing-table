name: Contract Tests

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.13'
  S3_BUCKET: 'quality-missingtable-com'
  CLOUDFRONT_DISTRIBUTION_ID: 'E15AUGI7OKJ99L'

permissions:
  id-token: write   # Required for OIDC
  contents: read
  actions: read     # Required for CI build number lookup

jobs:
  contract-tests:
    name: Contract Tests (Post-Deployment)
    runs-on: ubuntu-latest
    # Only run when CI workflow completes successfully (skip on failure)
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-quality
          aws-region: us-east-1

      - name: Verify deployment is live
        if: github.event_name == 'workflow_run'
        run: |
          echo "Polling /api/version until deployed commit matches ${{ github.event.workflow_run.head_sha }}"
          EXPECTED_SHA="${{ github.event.workflow_run.head_sha }}"

          for i in {1..30}; do
            DEPLOYED_SHA=$(curl -s https://api.missingtable.com/api/version | jq -r '.commit_sha' 2>/dev/null || echo "")

            if [ "$DEPLOYED_SHA" = "$EXPECTED_SHA" ]; then
              echo "✅ Deployment confirmed: $DEPLOYED_SHA"
              exit 0
            fi

            echo "Waiting... (attempt $i/30, expected: ${EXPECTED_SHA:0:7}, current: ${DEPLOYED_SHA:0:7})"
            sleep 10
          done

          echo "⚠️ Deployment not detected within 5 minutes"
          echo "Expected: $EXPECTED_SHA"
          echo "Current: $DEPLOYED_SHA"
          echo "Proceeding with contract tests anyway..."

      - name: Install Allure CLI
        run: |
          curl -fsSL https://github.com/allure-framework/allure2/releases/download/2.30.0/allure-2.30.0.tgz | tar -xz
          echo "$PWD/allure-2.30.0/bin" >> $GITHUB_PATH

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run contract tests against production
        id: contract-tests
        env:
          API_BASE_URL: https://api.missingtable.com
          ADMIN_TEST_USERNAME: ${{ secrets.TSC_ADMIN_USERNAME }}
          ADMIN_TEST_PASSWORD: ${{ secrets.TSC_ADMIN_PASSWORD }}
        run: |
          cd backend
          mkdir -p contract-allure-results
          uv run pytest tests/contract/ -m contract \
            --no-cov \
            --alluredir=contract-allure-results \
            -v
        continue-on-error: true

      - name: Generate contract Allure report
        run: |
          cd backend
          allure generate contract-allure-results -o contract-allure-report --clean

      - name: Extract build info
        id: build-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          APP_VERSION=$(cat VERSION 2>/dev/null || echo "0.0.0")
          COMMIT_SHA="${{ github.event.workflow_run.head_sha || github.sha }}"

          # Use CI workflow_run.run_number directly when triggered by CI
          CI_RUN_NUMBER=""
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            CI_RUN_NUMBER="${{ github.event.workflow_run.run_number }}"
          fi
          # Fallback: API lookup by SHA
          if [ -z "$CI_RUN_NUMBER" ]; then
            CI_RUN_NUMBER=$(gh api "repos/${{ github.repository }}/actions/workflows/ci.yml/runs?head_sha=${COMMIT_SHA}&per_page=1" \
              --jq '.workflow_runs[0].run_number // empty' 2>/dev/null || echo "")
          fi
          # Fallback: latest CI run on main
          if [ -z "$CI_RUN_NUMBER" ]; then
            CI_RUN_NUMBER=$(gh api "repos/${{ github.repository }}/actions/workflows/ci.yml/runs?branch=main&per_page=1&status=completed" \
              --jq '.workflow_runs[0].run_number // empty' 2>/dev/null || echo "")
          fi
          # Last resort: own run_number
          if [ -z "$CI_RUN_NUMBER" ]; then
            CI_RUN_NUMBER="${{ github.run_number }}"
            echo "Warning: Could not find CI build number, using own run_number"
          fi

          VERSION="${APP_VERSION}.${CI_RUN_NUMBER}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch=main" >> $GITHUB_OUTPUT
          echo "Build version: $VERSION (CI build #${CI_RUN_NUMBER})"

      - name: Add dashboard navigation to report
        env:
          BUILD_VERSION: ${{ steps.build-info.outputs.version }}
          COMMIT_SHA: ${{ github.event.workflow_run.head_sha || github.sha }}
        run: |
          COMMIT_SHORT="${COMMIT_SHA:0:7}"
          BANNER="<div style=\"background:#2563eb;color:white;padding:8px 16px;font-family:-apple-system,BlinkMacSystemFont,sans-serif;font-size:14px;position:fixed;top:0;left:0;right:0;z-index:9999;display:flex;align-items:center;justify-content:space-between;\"><a href=\"https://quality.missingtable.com\" style=\"color:white;text-decoration:none;display:flex;align-items:center;gap:8px;\"><span style=\"font-size:18px;\">←</span> Back to Quality Dashboard</a><span style=\"opacity:0.9;\">Build ${BUILD_VERSION} · main · ${COMMIT_SHORT} (post-deploy)</span></div><div style=\"height:40px;\"></div>"
          sed -i "s|<body>|<body>${BANNER}|" backend/contract-allure-report/index.html

      - name: Upload contract report to S3
        run: |
          # Upload latest contract report
          aws s3 sync backend/contract-allure-report/ s3://${S3_BUCKET}/latest/missing-table/prod/contract/ \
            --delete \
            --cache-control "max-age=300"

          # Archive contract report
          RUN_DATE=$(date -u +"%Y-%m-%d")
          aws s3 sync backend/contract-allure-report/ s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/contract/ \
            --cache-control "max-age=31536000"

      - name: Extract contract metadata
        run: |
          cd backend
          uv run ../scripts/extract-run-metadata.py \
            --run-id ${{ github.run_id }} \
            --commit-sha ${{ github.event.workflow_run.head_sha || github.sha }} \
            --trigger ${{ github.event_name }} \
            --workflow contract \
            --version "${{ steps.build-info.outputs.version }}" \
            --branch "${{ steps.build-info.outputs.branch }}" \
            --contract-allure-dir contract-allure-report \
            --output /tmp/contract-metadata.json

      - name: Download history and update
        run: |
          # Download existing history
          aws s3 cp s3://${S3_BUCKET}/data/history.json /tmp/history.json || echo '{"runs":[]}' > /tmp/history.json

          # Update history index with contract results
          cd backend
          uv run ../scripts/update-history-index.py \
            --current-run /tmp/contract-metadata.json \
            --history /tmp/history.json \
            --output /tmp/history.json \
            --max-runs 15

          # Upload updated history
          aws s3 cp /tmp/history.json s3://${S3_BUCKET}/data/history.json \
            --cache-control "max-age=300"

          # Archive contract metadata
          RUN_DATE=$(date -u +"%Y-%m-%d")
          aws s3 cp /tmp/contract-metadata.json \
            s3://${S3_BUCKET}/runs/missing-table/prod/${RUN_DATE}/${{ github.run_id }}/metadata.json \
            --cache-control "max-age=31536000"

      - name: Download test data and regenerate dashboard
        run: |
          # Download existing unit/journey/contract test summaries
          mkdir -p /tmp/backend-allure/widgets /tmp/data /tmp/contract-allure/widgets
          aws s3 cp s3://${S3_BUCKET}/latest/missing-table/prod/allure/widgets/summary.json /tmp/backend-allure/widgets/summary.json || true
          aws s3 cp s3://${S3_BUCKET}/latest/missing-table/prod/data/backend-coverage.json /tmp/data/backend-coverage.json || true
          aws s3 cp s3://${S3_BUCKET}/latest/missing-table/prod/data/frontend-results.json /tmp/data/frontend-results.json || true
          aws s3 cp s3://${S3_BUCKET}/latest/missing-table/prod/data/frontend-coverage.json /tmp/data/frontend-coverage.json || true
          aws s3 cp s3://${S3_BUCKET}/latest/missing-table/prod/data/api-inventory.json /tmp/data/api-inventory.json || true

          cd backend
          uv run ../scripts/generate-quality-dashboard.py \
            --output /tmp/index.html \
            --commit-sha ${{ github.event.workflow_run.head_sha || github.sha }} \
            --run-id ${{ github.run_id }} \
            --backend-allure-dir /tmp/backend-allure \
            --backend-coverage-json /tmp/data/backend-coverage.json \
            --frontend-results-json /tmp/data/frontend-results.json \
            --frontend-coverage-json /tmp/data/frontend-coverage.json \
            --contract-allure-dir contract-allure-report \
            --include-contract \
            --api-inventory-json /tmp/data/api-inventory.json \
            --history-json /tmp/history.json

          aws s3 cp /tmp/index.html s3://${S3_BUCKET}/index.html \
            --cache-control "max-age=300" \
            --content-type "text/html"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} \
            --paths "/latest/missing-table/prod/contract/*" "/index.html" "/data/*"

      - name: Summary
        run: |
          CT_PASSED=$(python3 -c "import json; print(json.load(open('backend/contract-allure-report/widgets/summary.json'))['statistic']['passed'])" 2>/dev/null || echo "N/A")
          CT_TOTAL=$(python3 -c "import json; print(json.load(open('backend/contract-allure-report/widgets/summary.json'))['statistic']['total'])" 2>/dev/null || echo "N/A")

          echo "### Contract Tests (Post-Deployment)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** CI workflow on main branch" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.event.workflow_run.head_sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Tests |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Contract | ${CT_PASSED}/${CT_TOTAL} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Contract Report](https://quality.missingtable.com/latest/missing-table/prod/contract/)" >> $GITHUB_STEP_SUMMARY

      - name: Check contract test results
        if: steps.contract-tests.outcome == 'failure'
        run: |
          echo "⚠️ Contract tests failed - check report for details"
          exit 1
