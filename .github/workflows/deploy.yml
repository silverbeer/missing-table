name: Deploy to GKE

# Trigger on:
# 1. Push to any branch (all deployments go to dev namespace)
# 2. Manual dispatch (for on-demand deployments)
on:
  push:
    branches:
      - '**'
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - '.github/workflows/security-scan.yml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip health checks after deployment'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      create_git_tag:
        description: 'Create git tag for this release (main branch only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  GCP_REGION: us-central1
  GKE_CLUSTER: missing-table-dev
  NAMESPACE: missing-table-dev  # All deployments go to dev namespace
  REGISTRY: us-central1-docker.pkg.dev/missing-table/missing-table
  ENVIRONMENT: dev  # Always dev environment now

# Prevent concurrent deployments
concurrency:
  group: missing-table-deployment
  cancel-in-progress: true  # Cancel old deployment, run the new one

permissions:
  contents: write  # Required to create git tags (main branch only)
  id-token: write  # Required for Workload Identity Federation
  pull-requests: write  # Required to comment on PRs

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version-info.outputs.version }}
      full-version: ${{ steps.version-info.outputs.full-version }}
      backend-image: ${{ steps.image-info.outputs.backend-image }}
      frontend-image: ${{ steps.image-info.outputs.frontend-image }}
      commit-sha: ${{ steps.version-info.outputs.commit-sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set version information
        id: version-info
        run: |
          # Read version from VERSION file
          VERSION=$(cat VERSION | tr -d '\n\r' | tr -d ' ')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          # Create full version with build ID (workflow run ID)
          FULL_VERSION="v${VERSION}-build.${{ github.run_id }}"
          echo "full-version=${FULL_VERSION}" >> $GITHUB_OUTPUT

          # Set commit SHA (short)
          COMMIT_SHA=$(git rev-parse --short HEAD)
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Version: ${FULL_VERSION}"
          echo "ðŸ“ Commit: ${COMMIT_SHA}"

          # Note if this is main branch (used for tagging)
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ðŸ·ï¸  Main branch - tag will be: v${VERSION}"
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        env:
          BUILD_ID: ${{ github.run_id }}
        run: |
          echo "ðŸ”¨ Building backend for dev environment..."

          # Use build-and-push.sh script with version support
          ./build-and-push.sh backend dev

      - name: Build and push frontend
        env:
          BUILD_ID: ${{ github.run_id }}
        run: |
          echo "ðŸ”¨ Building frontend for dev environment..."

          # Use build-and-push.sh script with version support
          ./build-and-push.sh frontend dev

      - name: Set image info for deployment
        id: image-info
        run: |
          VERSION="${{ steps.version-info.outputs.version }}"
          FULL_VERSION="${{ steps.version-info.outputs.full-version }}"

          # Images are tagged with environment tag (dev) and version tag
          BACKEND_IMAGE="${{ env.REGISTRY }}/backend:dev"
          FRONTEND_IMAGE="${{ env.REGISTRY }}/frontend:dev"

          echo "backend-image=${BACKEND_IMAGE}" >> $GITHUB_OUTPUT
          echo "frontend-image=${FRONTEND_IMAGE}" >> $GITHUB_OUTPUT

          echo "ðŸ³ Backend: ${BACKEND_IMAGE}"
          echo "ðŸ³ Frontend: ${FRONTEND_IMAGE}"

      - name: Build summary
        run: |
          echo "### ðŸ³ Docker Images Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.version-info.outputs.full-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.version-info.outputs.commit-sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`dev\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Images:**" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: \`${{ steps.image-info.outputs.backend-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: \`${{ steps.image-info.outputs.frontend-image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags created:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`dev\` (environment tag)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ steps.version-info.outputs.full-version }}\` (version with build ID)" >> $GITHUB_STEP_SUMMARY
          echo "- \`v${{ steps.version-info.outputs.version }}\` (semantic version)" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to GKE
    needs: [build-and-push]
    uses: ./.github/workflows/deploy-reusable.yml
    with:
      environment: dev
      namespace: missing-table-dev
      gke_cluster: missing-table-dev
      gcp_region: us-central1
      deployment_url: https://dev.missingtable.com
      replica_count_backend: 1
      replica_count_frontend: 1
      helm_timeout: '10m'
      health_check_retries: 5
      health_check_delay: 10
      enable_backup: ${{ github.ref == 'refs/heads/main' }}  # Only backup for main branch
      enable_git_tag: ${{ github.ref == 'refs/heads/main' && github.event.inputs.create_git_tag != 'false' }}  # Only tag main branch
      enable_pr_comment: true  # Comment on PRs
      skip_tests: ${{ github.event.inputs.skip_tests == 'true' }}
      backend_resources_requests_cpu: '250m'
      backend_resources_requests_memory: '256Mi'
      backend_resources_limits_cpu: '500m'
      backend_resources_limits_memory: '512Mi'
      frontend_resources_requests_cpu: '100m'
      frontend_resources_requests_memory: '128Mi'
      frontend_resources_limits_cpu: '250m'
      frontend_resources_limits_memory: '256Mi'
      commit_sha: ${{ needs.build-and-push.outputs.commit-sha }}
      version: ${{ needs.build-and-push.outputs.version }}
      full_version: ${{ needs.build-and-push.outputs.full-version }}
      backend_image: ${{ needs.build-and-push.outputs.backend-image }}
      frontend_image: ${{ needs.build-and-push.outputs.frontend-image }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SUPABASE_JWT_SECRET: ${{ secrets.SUPABASE_JWT_SECRET }}
      SERVICE_ACCOUNT_SECRET: ${{ secrets.SERVICE_ACCOUNT_SECRET }}
      RABBITMQ_USERNAME: ${{ secrets.RABBITMQ_USERNAME }}
      RABBITMQ_PASSWORD: ${{ secrets.RABBITMQ_PASSWORD }}
