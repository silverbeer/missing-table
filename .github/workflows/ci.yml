  name: CI

  on:
    push:
      branches: ['**']
    pull_request:
      branches: [main]
  env:
    PYTHON_VERSION: '3.13'
    NODE_VERSION: '20'

  permissions:
    contents: read
    packages: write


  jobs:
    lint:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Install uv
          uses: astral-sh/setup-uv@v5
          with:
            enable-cache: true
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: ${{ env.PYTHON_VERSION }}
        - name: Install dependencies
          run: |
            cd backend
            uv sync            
        - name: Run Ruff (Python lint)
          continue-on-error: true
          run: |
            cd backend
            uv run ruff check .
        - name: Run MyPy (Python type check)
          continue-on-error: true
          run: |
            cd backend
            uv run mypy .
        - name: Set up Node
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'
            cache-dependency-path: frontend/package-lock.json

        - name: Install frontend dependencies
          run: |
            cd frontend
            npm ci

        - name: Run frontend lint
          continue-on-error: true
          run: |
            cd frontend
            npm run lint
            npm run format:check


    test:
      needs: lint
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Install uv
          uses: astral-sh/setup-uv@v5
          with:
            enable-cache: true

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: ${{ env.PYTHON_VERSION }}

        - name: Install dependencies
          run: |
            cd backend
            uv sync

        - name: Run unit tests
          run: |
            cd backend
            uv run pytest tests/unit --no-cov -v
      

    build-and-push:
      needs: test
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main'
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and push backend
          run: |
            docker build -t ghcr.io/silverbeer/missing-table-backend:latest -f backend/Dockerfile backend/
            docker push ghcr.io/silverbeer/missing-table-backend:latest

        - name: Build and push frontend
          run: |
            docker build -t ghcr.io/silverbeer/missing-table-frontend:latest -f frontend/Dockerfile frontend/
            docker push ghcr.io/silverbeer/missing-table-frontend:latest

    deploy:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code          
          uses: actions/checkout@v4

        - name: Install doctl (DigitalOcean CLI)
          uses: digitalocean/action-doctl@v4
          with:
            token: ${{ secrets.DIGITALOCEAN_TOKEN }}

        - name: Get kubeconfig fro DOKS Cluster
          run: |
            doctl kubernetes cluster config save missingtable-dev

        - name: Install Helm
          uses: azure/setup-helm@v4
          with:
            version: 'latest'

        - name: Deploy to Kubernetes
          run: |
            helm upgrade --install missing-table ./helm/missing-table \
              --namespace missing-table-dev \
              --create-namespace \
              --values ./helm/missing-table/values-dev.yaml