  name: CI

  on:
    push:
      branches: ['**']
  env:
    PYTHON_VERSION: '3.13'
    NODE_VERSION: '20'

  permissions:
    contents: read
    packages: write


  jobs:
    lint:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
        - name: Install uv
          uses: astral-sh/setup-uv@v5
          with:
            enable-cache: true
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: ${{ env.PYTHON_VERSION }}
        - name: Install dependencies
          run: |
            cd backend
            uv sync            
        - name: Run Ruff (Python lint)
          run: |
            cd backend
            uv run ruff check .
        - name: Run MyPy (Python type check)
          continue-on-error: true
          run: |
            cd backend
            uv run mypy .
        - name: Set up Node
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'
            cache-dependency-path: frontend/package-lock.json

        - name: Install frontend dependencies
          run: |
            cd frontend
            npm ci

        - name: Run frontend lint
          run: |
            cd frontend
            npm run lint
            npm run format:check


    test-backend:
      needs: lint
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Install uv
          uses: astral-sh/setup-uv@v5
          with:
            enable-cache: true

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: ${{ env.PYTHON_VERSION }}

        - name: Install dependencies
          run: |
            cd backend
            uv sync

        - name: Run unit tests
          run: |
            cd backend
            uv run pytest tests/unit --no-cov -v

    test-frontend:
      needs: lint
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Set up Node
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'
            cache-dependency-path: frontend/package-lock.json

        - name: Install dependencies
          run: |
            cd frontend
            npm ci

        - name: Run unit tests
          run: |
            cd frontend
            npm run test:run

    build-and-push:
      needs: [test-backend, test-frontend]
      runs-on: ubuntu-latest
      if: github.ref == 'refs/heads/main'
      steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Log in to GHCR
          uses: docker/login-action@v3
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

        - name: Build and push backend
          run: |
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            docker build -t ghcr.io/silverbeer/missing-table-backend:${SHORT_SHA} -f backend/Dockerfile backend/
            docker push ghcr.io/silverbeer/missing-table-backend:${SHORT_SHA}

        - name: Build and push frontend
          run: |
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            docker build \
              --build-arg VITE_FARO_URL="${{ secrets.VITE_FARO_URL }}" \
              -t ghcr.io/silverbeer/missing-table-frontend:${SHORT_SHA} \
              -f frontend/Dockerfile frontend/
            docker push ghcr.io/silverbeer/missing-table-frontend:${SHORT_SHA}

    # GitOps: Update Helm values with new image tags
    # ArgoCD watches the repo and syncs changes to DOKS
    update-helm-values:
      needs: build-and-push
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            # Use PAT to bypass branch protection for automated commits
            token: ${{ secrets.GH_PAT }}
            ref: main
            fetch-depth: 0

        - name: Pull latest changes
          run: |
            git pull origin main

        - name: Update image tags and version info in values.yaml
          run: |
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VALUES_FILE="helm/missing-table/values-prod.yaml"

            # Read version from VERSION file
            VERSION=$(cat VERSION | tr -d '\n')
            BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            # Update backend tag (line with # backend-tag marker)
            sed -i "s|tag: \".*\" # backend-tag|tag: \"${SHORT_SHA}\" # backend-tag|" $VALUES_FILE

            # Update frontend tag (line with # frontend-tag marker)
            sed -i "s|tag: \".*\" # frontend-tag|tag: \"${SHORT_SHA}\" # frontend-tag|" $VALUES_FILE

            # Update version information
            sed -i "s|version: \".*\" # version-tag|version: \"${VERSION}\" # version-tag|" $VALUES_FILE
            sed -i "s|buildId: \".*\" # build-id|buildId: \"${{ github.run_number }}\" # build-id|" $VALUES_FILE
            sed -i "s|commitSha: \".*\" # commit-sha|commitSha: \"${{ github.sha }}\" # commit-sha|" $VALUES_FILE
            sed -i "s|buildDate: \".*\" # build-date|buildDate: \"${BUILD_DATE}\" # build-date|" $VALUES_FILE

            echo "Updated tags to ${SHORT_SHA}, version to ${VERSION}"
            cat $VALUES_FILE

        - name: Commit and push
          run: |
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add helm/missing-table/values-prod.yaml
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
              VERSION=$(cat VERSION | tr -d '\n')
              git commit -m "chore: Update image tags to ${SHORT_SHA}

            Version: ${VERSION}
            Build: ${{ github.run_number }}

            [skip ci]"
              git push
            fi
